<header class="d-flex flex-wrap justify-content-between align-items-center">
  <div>
    <span class="big">Tokens</span>
  </div>
  <div class="d-flex align-items-center">
    <input id="search" type="text" placeholder="Search" class="d-none mb-1 ml-3 form-control bg-dark text-white border-0 btn-outline-warning">
  </div>
</header>

<div id="card_loading" class="d-flex justify-content-center">
  <div class="spinner-border"></div>
</div>

<table class="table darker table-responsive table-borderless d-none">
  <thead>
    <tr>
      <th style="width: 5%;">SYMBOL</th>
      <th style="width: 35%;">NAME</th>
      <th style="width: 10%;">PRICE</th>
      <th style="width: 15%;">M CAP</th>
      <th style="width: 5%;">% CHANGE</th>
      <th style="width: 15%;">24H VOL</th>
      <th style="width: 5%;"></th>
    </tr>
  </thead>
  <tbody id="tokens_table">
  </tbody>
</table>

<script>
  async function tokens_page () {
    const tokens = await getData('tokens', 'tokens');
    const metrics = await getData('market', 'metrics');

    function renderTable(list) {
      let table = ``;
      const isChangePositive = (change) => {
        const n = change.replace('%', '');
        if (BigNumber(n).lt(0)) return false;

        return true;
      };

      for (const token of list) {
        table +=
        `<tr>
          <td>${token.symbol}</td>
          <td>
            ${token.name}
          </td>
          <td>
            $${n(token.price)}
          </td>
          <td>$${n(token.marketCap)}</td>
          <td class="${isChangePositive(token.change) ? 'text-success' : 'text-danger'}">${token.change}</td>
          <td>$${n(token.volume)}</td>
          <td class="d-flex flex-row float-right">
            <a type="button" href="?p=market&symbol=${token.symbol}" class="btn tbl_btn pushBTN" title="Market">
              <svg width="1.3em" height="1.3em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
              </svg>
            </a>
          </td>
        </tr>`;
      }
      $('#tokens_table').html(table);
    }

    const list = [];
    const hivePrice = await getHivePrice();
    for (const token of tokens) {
      const metric = metrics.find(el => el.symbol === token.symbol);

      // calculate metrics
      const price = metric ?
        BigNumber(metric.lastPrice)
          .multipliedBy(hivePrice)
          .toString()
        : '0';
      const marketCap = BigNumber(token.circulatingSupply)
        .multipliedBy(price)
        .toFixed(3)
        .toString();
      const change = metric ? metric.priceChangePercent : '0%';
      const volume = metric ?
        BigNumber(metric.volume)
          .multipliedBy(hivePrice)
          .toFixed(3)
          .toString()
        : '0';
      
      list.push({
        symbol: token.symbol,
        name: token.name,
        price: parseFloat(price).toFixed(5),
        marketCap,
        change,
        volume
      });
    }

    // sort the list with 24h volume (desc)
    list.sort(function (a, b) {
      if (BigNumber(a.volume).lt(b.volume)) return 1;
      if (BigNumber(b.volume).lt(a.volume)) return -1;

      return 0;
    });

    renderTable(list);
    $('#card_loading').remove();
    $('#search').removeClass('d-none');
    $('table').removeClass('d-none');

    $('#search').on('keyup', function () {
      const searchWord = $(this).val().toLowerCase().trim();
      const filteredTokens = [];
      for (const token of list) {
        if (token.symbol.toLowerCase().includes(searchWord)) {
          filteredTokens.push(token);
        }
      }

      // re-render table with filtered records
      renderTable(filteredTokens);
    });
  }
  tokens_page();
</script>
